frontend_build:
  docker:
    - image: cimg/node:20.5
  working_directory: ~/repo
  steps:
    - checkout

    # Fix permissions at the start
    - run:
        name: Fix permissions
        command: sudo chown -R circleci:circleci .

    # Restore cached dependencies if available
    - restore_cache:
        keys:
          - v1-frontend-dependencies-{{ checksum "frontend/package-lock.json" }}

    # Install frontend dependencies
    - run:
        name: Install frontend dependencies
        command: |
          cd frontend
          npm install

    # Save node_modules to cache for faster future builds
    - save_cache:
        paths:
          - ./frontend/node_modules
        key: v1-frontend-dependencies-{{ checksum "frontend/package-lock.json" }}

    # Run frontend linting (optional, but recommended)
    - run:
        name: Lint frontend code
        command: |
          cd frontend
          npx eslint . || echo "⚠️ Lint warnings present"

    # Run frontend tests (if any)
    - run:
        name: Run frontend tests
        command: |
          cd frontend
          if [ -f package.json ]; then
            npm test -- --watchAll=false || echo "⚠️ No tests or some failed — please review."
          else
            echo "No test configuration found."
          fi

    # Build frontend
    - run:
        name: Build frontend
        command: |
          cd frontend
          npm run build
